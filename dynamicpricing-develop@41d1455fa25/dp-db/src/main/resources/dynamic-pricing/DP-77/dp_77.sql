

DELETE FROM `RA_TNT_APP_PARAMS` WHERE `ATTR_KEY` = 'INITIAL_HUBZU_QUERY';

SELECT ID from `RA_TNT_APPS` WHERE LOWER(code) = 'dpa' INTO @APP_ID;
INSERT INTO `RA_TNT_APP_PARAMS` (`ID`, `RA_TNT_APP_ID`, `ATTR_KEY`, `ATTR_VALUE`, `CREATED_BY`, `CREATED_ON`) VALUES (UUID(), @APP_ID, 'INITIAL_HUBZU_QUERY', 'SELECT T1.RBID_PROP_ID_VC_FK, T1.RBID_PROP_LIST_ID_VC_PK, T1.LIST_STTS_DTLS_VC, T1.LIST_PRCE_NT, T1.LIST_STRT_DATE_DT_NN, T1.LIST_END_DATE_DT_NN, OT1.SELR_PROP_ID_VC_NN, OT1.PROP_STAT_ID_VC_FK, OT1.PROP_ZIP_VC_FK FROM RRRBPMTX_PROP_LIST T1, RRRBPMMS_PROP OT1, ( SELECT RBID_PROP_ID_VC_FK FROM RRRBPMTX_PROP_LIST WHERE (RBID_PROP_ID_VC_FK, TO_NUMBER(regexp_replace(RBID_PROP_LIST_ID_VC_PK,\'[[:alpha:]]\'))) IN ( SELECT RBID_PROP_ID_VC_FK, MAX(TO_NUMBER(regexp_replace(RBID_PROP_LIST_ID_VC_PK,\'[[:alpha:]]\'))) FROM RRRBPMTX_PROP_LIST  WHERE RBID_PROP_ID_VC_FK IN  (SELECT A1.RBID_PROP_ID_VC_FK  FROM   (SELECT RBID_PROP_ID_VC_FK, COUNT(LIST_TYPE_ID_VC_FK) AS CNT FROM RRRBPMTX_PROP_LIST WHERE LIST_TYPE_ID_VC_FK = \'AUCN\' GROUP BY RBID_PROP_ID_VC_FK, LIST_TYPE_ID_VC_FK ) A1, (SELECT RBID_PROP_ID_VC_FK, COUNT(RBID_PROP_ID_VC_FK) AS CNT  FROM RRRBPMTX_PROP_LIST GROUP BY RBID_PROP_ID_VC_FK ) A2 WHERE A1.RBID_PROP_ID_VC_FK = A2.RBID_PROP_ID_VC_FK AND A1.CNT = A2.CNT) AND LIST_STRT_DATE_DT_NN BETWEEN TO_DATE(?) AND TO_DATE(?) GROUP BY RBID_PROP_ID_VC_FK) AND LIST_TYPE_ID_VC_FK = \'AUCN\'  AND (LIST_STTS_DTLS_VC <> \'SUCCESSFUL\' OR LIST_STTS_DTLS_VC is null)) T2 WHERE T1.RBID_PROP_ID_VC_FK = T2.RBID_PROP_ID_VC_FK AND T1.LIST_TYPE_ID_VC_FK = \'AUCN\' AND (T1.LIST_STTS_DTLS_VC NOT IN (\'CANCELLED\',\'DISAPROVED\') OR T1.LIST_STTS_DTLS_VC IS NULL) AND T1.RBID_PROP_ID_VC_FK = OT1.RBID_PROP_ID_VC_PK  ORDER BY T1.LIST_END_DATE_DT_NN DESC, TO_NUMBER(regexp_replace(T1.RBID_PROP_LIST_ID_VC_PK,\'[[:alpha:]]\')) DESC, T1.RBID_PROP_ID_VC_FK DESC', 'SYSTEM', NOW());

